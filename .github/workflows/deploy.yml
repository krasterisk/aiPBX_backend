name: Deploy Backend to Production

on:
  push:
    branches: [master]
    paths-ignore:
      - "*.md"
      - ".docs/**"
  # Ручной запуск с выбором сервера
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - aipbxnet_production
          - aipbxorg_production
          - aipbxru_production

jobs:
  # ─── Step 1: Determine which servers to deploy ──
  prepare:
    name: Prepare Deploy Matrix
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.set-matrix.outputs.servers }}
    steps:
      - name: Set server matrix
        id: set-matrix
        run: |
          # Ручной запуск — используем выбранный target
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.target }}" == "all" ]]; then
              echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
            else
              echo 'servers=["${{ github.event.inputs.target }}"]' >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Push — парсим commit message
          MSG="${{ github.event.head_commit.message }}"

          if [[ "$MSG" == *"[skip deploy]"* ]]; then
            echo "Deploy skipped by commit message"
            echo 'servers=[]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:1]"* ]]; then
            echo "Deploy only to aipbxnet"
            echo 'servers=["aipbxnet_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:2]"* ]]; then
            echo "Deploy only to aipbxorg"
            echo 'servers=["aipbxorg_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:3]"* ]]; then
            echo "Deploy only to aipbxru"
            echo 'servers=["aipbxru_production"]' >> $GITHUB_OUTPUT
          else
            echo "Deploy to all servers"
            echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
          fi

  # ─── Step 2: Deploy backend to servers ───────
  deploy:
    name: Deploy Backend (${{ matrix.server }})
    needs: [prepare]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.servers) }}
      fail-fast: false
    environment: ${{ matrix.server }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -e
            echo "Starting backend deployment to ${{ matrix.server }}..."

            # ── Pull latest backend code ──
            echo "Pulling backend..."
            git config --global --add safe.directory /app/aiPBX_backend
            sudo chown -R $(whoami):$(whoami) /app/aiPBX_backend
            cd /app/aiPBX_backend && git pull origin master

            cd /app

            # ── Rebuild & restart only backend ──
            echo "Building and deploying backend..."
            sudo docker compose -f docker-compose.production.yml --env-file .env.production up -d \
              --build \
              --force-recreate backend

            # ── Wait for health checks ──
            echo "Waiting for backend to start..."
            sleep 15

            # ── Verify deployment ──
            echo "Checking health..."
            HEALTH=$(sudo docker inspect --format='{{.State.Health.Status}}' app-backend-1 2>/dev/null || echo "unknown")
            if [ "$HEALTH" = "healthy" ]; then
              echo "Health check passed!"
            else
              echo "Health check status: $HEALTH, checking containers..."
              sudo docker compose -f docker-compose.production.yml --env-file .env.production ps
              sudo docker compose -f docker-compose.production.yml --env-file .env.production logs --tail=50 backend
              exit 1
            fi

            # ── Cleanup ──
            sudo docker image prune -f
            echo "Backend deployment to ${{ matrix.server }} successful!"