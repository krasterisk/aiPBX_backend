name: Deploy Backend to Production

on:
  push:
    branches: [master]
    paths-ignore:
      - "*.md"
      - ".docs/**"
  # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Å –≤—ã–±–æ—Ä–æ–º —Å–µ—Ä–≤–µ—Ä–∞
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - aipbxnet_production
          - aipbxorg_production
          - aipbxru_production

jobs:
  # ‚îÄ‚îÄ‚îÄ Step 1: Determine which servers to deploy ‚îÄ‚îÄ
  prepare:
    name: üìã Prepare Deploy Matrix
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.set-matrix.outputs.servers }}
    steps:
      - name: Set server matrix
        id: set-matrix
        run: |
          # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π target
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.target }}" == "all" ]]; then
              echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
            else
              echo 'servers=["${{ github.event.inputs.target }}"]' >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Push ‚Äî –ø–∞—Ä—Å–∏–º commit message
          MSG="${{ github.event.head_commit.message }}"

          if [[ "$MSG" == *"[skip deploy]"* ]]; then
            echo "‚è≠Ô∏è Deploy skipped by commit message"
            echo 'servers=[]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:1]"* ]]; then
            echo "üéØ Deploy only to aipbxnet"
            echo 'servers=["aipbxnet_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:2]"* ]]; then
            echo "üéØ Deploy only to aipbxorg"
            echo 'servers=["aipbxorg_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:3]"* ]]; then
            echo "üéØ Deploy only to aipbxru"
            echo 'servers=["aipbxru_production"]' >> $GITHUB_OUTPUT
          else
            echo "üåê Deploy to all servers"
            echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
          fi

  # ‚îÄ‚îÄ‚îÄ Step 2: Deploy backend to servers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  deploy:
    name: üöÄ Deploy Backend (${{ matrix.server }})
    needs: [prepare]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.servers) }}
      fail-fast: false
    environment: ${{ matrix.server }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            echo "üöÄ Starting backend deployment to ${{ matrix.server }}..."

            # ‚îÄ‚îÄ Pull latest backend code ‚îÄ‚îÄ
            echo "üì• Pulling backend..."
            cd /app/aiPBX_backend && git pull origin master

            cd /app

            # ‚îÄ‚îÄ Rebuild & restart only backend ‚îÄ‚îÄ
            echo "üî® Building and deploying backend..."
            docker compose -f docker-compose.production.yml --env-file .env.production up -d \
              --build \
              --force-recreate backend \
              --no-deps

            # ‚îÄ‚îÄ Wait for health checks ‚îÄ‚îÄ
            echo "‚è≥ Waiting for backend to start..."
            sleep 15

            # ‚îÄ‚îÄ Verify deployment ‚îÄ‚îÄ
            echo "üè• Checking health..."
            if curl -sf --max-time 10 http://localhost/api/health > /dev/null 2>&1; then
              echo "‚úÖ Health check passed!"
            else
              echo "‚ö†Ô∏è Health check failed, checking containers..."
              docker compose -f docker-compose.production.yml ps
              docker compose -f docker-compose.production.yml logs --tail=50 backend
              exit 1
            fi

            # ‚îÄ‚îÄ Cleanup ‚îÄ‚îÄ
            docker image prune -f
            echo "‚úÖ Backend deployment to ${{ matrix.server }} successful!"

      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "‚ùå Backend deploy to ${{ matrix.server }} failed!"
          fields: repo,message,commit,author
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}

      - name: Notify on success
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "‚úÖ Backend deploy to ${{ matrix.server }} successful!"
          fields: repo,message,commit,author
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
